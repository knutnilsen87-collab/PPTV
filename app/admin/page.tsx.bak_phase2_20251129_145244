import { getServerSession } from "next-auth";
import { redirect } from "next/navigation";
import { revalidatePath } from "next/cache";
import { authOptions } from "@/lib/auth";
import { db } from "@/lib/db";

export const dynamic = "force-dynamic";

async function updateUserRole(formData: FormData) {
  "use server";

  const session = await getServerSession(authOptions);

  if (!session?.user || !session.user.role) {
    redirect("/login?callbackUrl=/admin");
  }

  const role = session.user.role;
  if (role !== "ADMIN" && role !== "SUPERADMIN") {
    redirect("/");
  }

  const userId = formData.get("userId")?.toString();
  const newRole = formData.get("role")?.toString();

  if (!userId || !newRole) {
    return;
  }

  // Simple safety: don't allow changing your own role from here
  if (session.user.id && session.user.id === userId) {
    return;
  }

  await db.user.update({
    where: { id: userId },
    data: { role: newRole },
  });

  revalidatePath("/admin");
}

export default async function AdminPage() {
  const session = await getServerSession(authOptions);

  if (!session?.user) {
    redirect("/login?callbackUrl=/admin");
  }

  if (session.user.role !== "ADMIN" && session.user.role !== "SUPERADMIN") {
    redirect("/");
  }

  const [users, userCount] = await Promise.all([
    db.user.findMany({
      orderBy: { createdAt: "desc" },
      take: 50,
    }),
    db.user.count(),
  ]);

  // These may fail if Video / Vote models change later – keep them best-effort
  let videoCount = 0;
  let voteCount = 0;

  try {
    videoCount = await db.video.count();
  } catch {
    videoCount = 0;
  }

  try {
    voteCount = await db.vote.count();
  } catch {
    voteCount = 0;
  }

  const currentUserId = session.user.id as string | undefined;

  return (
    <main className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12 space-y-8">
      <header className="space-y-1">
        <p className="text-xs font-semibold uppercase tracking-[0.25em] text-slate-500">
          Admin control room
        </p>
        <h1 className="text-3xl font-semibold tracking-tight">
          ProPokerTV backoffice
        </h1>
        <p className="text-sm text-slate-400 max-w-2xl">
          Manage users, content and community features. This is a placeholder
          admin panel – real moderation, feature flags and advanced analytics can be wired in here.
        </p>
      </header>

      {/* Top stats */}
      <section className="grid gap-4 md:grid-cols-3">
        <div className="rounded-2xl border border-slate-800 bg-slate-950/70 p-4 space-y-2">
          <p className="text-xs font-medium text-slate-400">Registered users</p>
          <p className="text-3xl font-semibold">{userCount}</p>
          <p className="text-xs text-slate-500">
            Including admins, creators and viewers.
          </p>
        </div>

        <div className="rounded-2xl border border-slate-800 bg-slate-950/70 p-4 space-y-2">
          <p className="text-xs font-medium text-slate-400">Videos in catalog</p>
          <p className="text-3xl font-semibold">{videoCount}</p>
          <p className="text-xs text-slate-500">
            Streams, VODs and highlight clips.
          </p>
        </div>

        <div className="rounded-2xl border border-slate-800 bg-slate-950/70 p-4 space-y-2">
          <p className="text-xs font-medium text-slate-400">Play of the Week votes</p>
          <p className="text-3xl font-semibold">{voteCount}</p>
          <p className="text-xs text-slate-500">
            Community engagement on hero moments.
          </p>
        </div>
      </section>

      {/* User management */}
      <section className="rounded-2xl border border-slate-800 bg-slate-950/70 p-6 space-y-4">
        <div className="flex items-center justify-between gap-4">
          <div>
            <p className="text-xs font-semibold uppercase tracking-[0.25em] text-slate-500">
              Users
            </p>
            <p className="text-xs text-slate-400">
              Change roles for players, creators and admins. More filters and bulk actions can be added later.
            </p>
          </div>
        </div>

        <div className="overflow-x-auto">
          <table className="min-w-full text-xs">
            <thead>
              <tr className="border-b border-slate-800 text-slate-400">
                <th className="py-2 pr-3 text-left font-medium">Name</th>
                <th className="py-2 px-3 text-left font-medium">Email</th>
                <th className="py-2 px-3 text-left font-medium">Role</th>
                <th className="py-2 px-3 text-left font-medium">Joined</th>
                <th className="py-2 pl-3 text-right font-medium">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-800/80">
              {users.map((u) => {
                const isSelf = currentUserId && u.id === currentUserId;

                return (
                  <tr key={u.id} className="text-slate-200/90">
                    <td className="py-2 pr-3 align-middle">
                      <div className="flex flex-col">
                        <span className="font-medium">
                          {u.displayName ?? u.name ?? "Unnamed user"}
                        </span>
                        {u.name && u.displayName && u.displayName !== u.name && (
                          <span className="text-[11px] text-slate-500">
                            Legal name: {u.name}
                          </span>
                        )}
                      </div>
                    </td>
                    <td className="py-2 px-3 align-middle text-slate-300">
                      {u.email}
                    </td>
                    <td className="py-2 px-3 align-middle">
                      <span className="inline-flex items-center rounded-full border border-slate-700 bg-slate-900 px-2 py-0.5 text-[11px] font-semibold">
                        {u.role ?? "USER"}
                      </span>
                    </td>
                    <td className="py-2 px-3 align-middle text-slate-400">
                      {u.createdAt
                        ? new Date(u.createdAt).toLocaleDateString()
                        : "—"}
                    </td>
                    <td className="py-2 pl-3 align-middle text-right">
                      <form action={updateUserRole} className="inline-flex items-center gap-2">
                        <input type="hidden" name="userId" value={u.id} />
                        <select
                          name="role"
                          defaultValue={u.role ?? "USER"}
                          disabled={isSelf}
                          className="rounded-full border border-slate-700 bg-slate-900/80 px-2 py-1 text-[11px] text-slate-100 outline-none focus:border-amber-400 focus:ring-1 focus:ring-amber-400 disabled:opacity-60"
                        >
                          <option value="USER">USER</option>
                          <option value="ADMIN">ADMIN</option>
                        </select>
                        <button
                          type="submit"
                          disabled={isSelf}
                          className="rounded-full bg-amber-400 px-3 py-1 text-[11px] font-semibold text-slate-900 shadow shadow-amber-500/30 hover:bg-amber-300 disabled:opacity-60 disabled:cursor-not-allowed transition-colors"
                        >
                          Save
                        </button>
                      </form>
                    </td>
                  </tr>
                );
              })}
              {users.length === 0 && (
                <tr>
                  <td
                    colSpan={5}
                    className="py-6 text-center text-slate-500 text-xs"
                  >
                    No users yet. When players sign up, they will appear here.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </section>

      {/* Roadmap / placeholder */}
      <section className="rounded-2xl border border-slate-800 bg-slate-950/40 p-6 space-y-3">
        <p className="text-xs font-semibold uppercase tracking-[0.25em] text-slate-500">
          What's next for admins?
        </p>
        <ul className="text-xs text-slate-400 space-y-1.5">
          <li>• Creator onboarding and verification tools.</li>
          <li>• Moderation tools for clips, comments and Play of the Week candidates.</li>
          <li>• Feature flags and A/B tests for new UX experiments.</li>
          <li>• Simple analytics: viewer growth, clip performance and engagement funnels.</li>
        </ul>
      </section>
    </main>
  );
}
