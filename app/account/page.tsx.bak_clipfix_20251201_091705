import { getServerSession } from "next-auth";
import { redirect } from "next/navigation";
import { db } from "@/lib/db";
import { authOptions } from "@/lib/auth";
import { ClipUploadForm } from "@/components/ClipUploadForm";

export const dynamic = "force-dynamic";

export default async function AccountPage() {
  const session = await getServerSession(authOptions as any);

  if (!session?.user?.email) {
    redirect("/login?callbackUrl=/account");
  }

  const user = await db.user.findUnique({
    where: { email: session.user.email as string },
  });

  if (!user) {
    redirect("/login?callbackUrl=/account");
  }

  const clips = await db.clip.findMany({
    where: { userId: user.id },
    orderBy: { createdAt: "desc" },
  });

  const createdAt =
    user.createdAt instanceof Date
      ? user.createdAt
      : new Date(user.createdAt as any);

  const memberSince =
    createdAt && !Number.isNaN(createdAt.getTime())
      ? new Intl.DateTimeFormat("en-US", {
          year: "numeric",
          month: "short",
        }).format(createdAt)
      : "Unknown";

  return (
    <div className="min-h-screen bg-slate-950 text-slate-50">
      <main className="mx-auto flex w-full max-w-5xl flex-col gap-6 px-4 py-10 lg:px-6">
        {/* Header */}
        <div className="flex flex-col justify-between gap-4 sm:flex-row sm:items-end">
          <div>
            <p className="text-xs uppercase tracking-[0.2em] text-accent-poker/80">
              Player hub
            </p>
            <h1 className="text-2xl font-semibold text-slate-50 sm:text-3xl">
              {user.displayName || user.name || "Your ProPokerTV account"}
            </h1>
            <p className="mt-2 text-sm text-slate-400">
              Manage your public creator profile and upload new clips directly
              to the review pipeline.
            </p>
          </div>
          <div className="rounded-2xl border border-slate-800 bg-slate-950/70 px-4 py-3 text-xs text-slate-300 shadow-md shadow-black/40">
            <div className="flex items-center justify-between gap-4">
              <span className="font-medium text-slate-200">Role</span>
              <span className="rounded-full bg-slate-900 px-2 py-0.5 text-[11px] uppercase tracking-wide text-accent-poker">
                {user.role}
              </span>
            </div>
            <div className="mt-1 flex items-center justify-between gap-4">
              <span className="text-slate-400">Member since</span>
              <span>{memberSince}</span>
            </div>
          </div>
        </div>

        {/* Two-column layout */}
        <div className="grid gap-6 lg:grid-cols-[minmax(0,2fr)_minmax(0,1.4fr)]">
          {/* Left: profile & info */}
          <div className="space-y-5">
            <div className="rounded-2xl border border-slate-800 bg-slate-950/60 p-5 shadow-lg shadow-black/40">
              <h2 className="mb-2 text-sm font-semibold text-slate-50">
                Profile basics
              </h2>
              <p className="mb-4 text-sm text-slate-400">
                This is your creator identity on ProPokerTV. In later phases
                you&apos;ll be able to customize avatar, country flags, preferred
                formats and more.
              </p>
              <dl className="grid gap-3 text-sm text-slate-300 sm:grid-cols-2">
                <div>
                  <dt className="text-xs uppercase tracking-wide text-slate-500">
                    Display name
                  </dt>
                  <dd className="mt-1">
                    {user.displayName || user.name || "Not set yet"}
                  </dd>
                </div>
                <div>
                  <dt className="text-xs uppercase tracking-wide text-slate-500">
                    Email
                  </dt>
                  <dd className="mt-1 break-all">{user.email}</dd>
                </div>
                <div>
                  <dt className="text-xs uppercase tracking-wide text-slate-500">
                    Country
                  </dt>
                  <dd className="mt-1">
                    {user.country || "Will be available in a later phase"}
                  </dd>
                </div>
                <div>
                  <dt className="text-xs uppercase tracking-wide text-slate-500">
                    Favourite format
                  </dt>
                  <dd className="mt-1">
                    {user.favoriteVariant || "Cash, MTTs, mixed games..."}
                  </dd>
                </div>
              </dl>
            </div>

            <div className="rounded-2xl border border-slate-800 bg-slate-950/60 p-5 text-sm text-slate-300 shadow-lg shadow-black/40">
              <h2 className="mb-2 text-sm font-semibold text-slate-50">
                Your public creator profile
              </h2>
              <p>
                Phase 2 will expose a{" "}
                <span className="font-mono text-accent-poker">
                  /creator/&lt;id&gt;
                </span>{" "}
                page for every player on the platform. Clips you upload here can
                be connected to that profile and highlighted on the front page,
                in the clips centre and inside live streams.
              </p>
              <p className="mt-2 text-slate-400">
                For now this area is mainly a playground for us to ensure the
                account system, uploads and admin review flow are working
                correctly end-to-end.
              </p>
            </div>
          </div>

          {/* Right: upload form */}
          <ClipUploadForm userId={user.id} />
        </div>

        {/* My clips */}
        <section className="mt-4 space-y-3">
          <div className="flex items-center justify-between gap-4">
            <h2 className="text-sm font-semibold text-slate-50">
              My uploaded clips
            </h2>
            <p className="text-xs text-slate-500">
              This is a simple internal view. In later phases you&apos;ll get
              full stats, performance and revenue sharing here.
            </p>
          </div>

          {clips.length === 0 ? (
            <p className="rounded-2xl border border-dashed border-slate-700 bg-slate-950/70 px-4 py-6 text-sm text-slate-400">
              You haven&apos;t uploaded any clips yet. Once you start adding
              content, they will show up here with status and basic metadata.
            </p>
          ) : (
            <div className="grid gap-4 md:grid-cols-2">
              {clips.map((clip) => (
                <div
                  key={clip.id}
                  className="flex flex-col gap-3 rounded-2xl border border-slate-800 bg-slate-950/80 p-4 shadow-md shadow-black/40"
                >
                  <div className="flex items-start justify-between gap-3">
                    <div>
                      <h3 className="text-sm font-semibold text-slate-50">
                        {clip.title}
                      </h3>
                      {clip.description ? (
                        <p className="mt-1 text-xs text-slate-400 line-clamp-2">
                          {clip.description}
                        </p>
                      ) : (
                        <p className="mt-1 text-xs text-slate-500">
                          No description yet.
                        </p>
                      )}
                    </div>
                    <span className="rounded-full bg-slate-900 px-2 py-0.5 text-[10px] font-medium uppercase tracking-wide text-slate-300">
                      {clip.status}
                    </span>
                  </div>
                  {clip.videoUrl ? (
                    <div className="overflow-hidden rounded-xl border border-slate-800 bg-black/80">
                      <video
                        className="h-40 w-full object-cover"
                        controls
                        src={clip.videoUrl}
                      />
                    </div>
                  ) : (
                    <div className="flex h-24 items-center justify-center rounded-xl border border-dashed border-slate-700 bg-slate-950/60 text-xs text-slate-500">
                      No video URL stored yet.
                    </div>
                  )}
                  <p className="text-[11px] text-slate-500">
                    Stored at:{" "}
                    <span className="font-mono text-slate-300">
                      {clip.videoUrl}
                    </span>
                  </p>
                </div>
              ))}
            </div>
          )}
        </section>
      </main>
    </div>
  );
}
